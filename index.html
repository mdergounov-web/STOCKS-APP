<!DOCTYPE html> 
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>STOCKS ‚Äì March√©</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #fff;
    text-align: center;
  }

  h1 {
    margin-top: 20px;
  }

  button, select {
    padding: 10px 15px;
    font-size: 16px;
    margin: 10px;
  }

  #timer {
    font-size: 28px;
    margin: 20px;
    color: #00ffcc;
  }

  #zoneDes {
    margin: 20px auto;
    padding: 20px;
    border: 2px solid #444;
    width: 420px;
    min-height: 180px;
  }

  .dice {
    font-size: 60px;
    display: inline-block;
    margin: 0 20px;
    animation: shake 0.4s infinite;
  }

  @keyframes shake {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(10deg); }
    50% { transform: rotate(-10deg); }
    75% { transform: rotate(10deg); }
    100% { transform: rotate(0deg); }
  }

  table {
    margin: 30px auto;
    border-collapse: collapse;
    background: #222;
  }

  th, td {
    border: 1px solid #555;
    padding: 8px 12px;
  }

  th {
    background: #333;
  }

  /* Bouton passer cach√© par d√©faut */
  #btnPasser {
    display: none;
  }
</style>
</head>

<body>

<h1>STOCKS ‚Äì Le Jeu de la Bourse</h1>

<div>
  ‚è±Ô∏è Dur√©e de la partie :
  <select id="selectTemps">
    <option value="20">20 minutes (mode stress)</option>
    <option value="30" selected>30 minutes (mode interm√©diaire - recommand√©)</option>
    <option value="40">40 minutes (mode strat√©gie)</option>
    <option value="-1">Illimit√© (mode personnalis√©)</option>
  </select>
</div>

<div id="timer">‚è±Ô∏è --:--</div>

<button onclick="demarrerPartie()">‚ñ∂Ô∏è Commencer la partie</button>
<button onclick="clotureMarche()">üìâ Cl√¥ture du march√©</button>

<!-- Nouveau bouton -->
<button id="btnPasser" onclick="passerCinematique()">‚è≠Ô∏è Passer</button>

<div id="zoneDes">
  <p>En attente de la cl√¥ture‚Ä¶</p>
</div>

<table id="tablePrix">
  <tr>
    <th>Action</th>
    <th>Prix initial (‚Ç¨)</th>
  </tr>
</table>

<script>
/* ===============================
   DONN√âES
================================ */

let tempsRestant = null;
let timerInterval = null;
let numeroCloture = 0;
let partieDemarree = false;

/* Gestion du bouton "Passer" */
let modePasser = false;            // une fois activ√©, skip sur toute la cl√¥ture en cours
let animationActive = false;       // une animation de d√©s est en cours
let animationResolve = null;       // fonction pour terminer instantan√©ment l'action courante

const btnPasser = document.getElementById("btnPasser");

function afficherBoutonPasser() {
  btnPasser.style.display = "inline-block";
}

function cacherBoutonPasser() {
  btnPasser.style.display = "none";
}

const prixActions = {
  "POMME": 80,
  "BOREAL": 72,
  "LOUIS TUIVON": 60,
  "D.E.F.": 55,
  "FT1": 48,
  "SUNGMAS": 40,
  "LLATENU": 35,
  "CARI NOPER": 28,
  "TALTO": 20,
  "SOTA": 15
};

/* ===============================
   TABLEAU
================================ */

const table = document.getElementById("tablePrix");

Object.keys(prixActions).forEach(action => {
  const row = document.createElement("tr");
  row.innerHTML = `<td>${action}</td><td>${prixActions[action]} ‚Ç¨</td>`;
  table.appendChild(row);
});

/* ===============================
   D√âMARRAGE PARTIE
================================ */

function demarrerPartie() {
  if (partieDemarree) return;

  partieDemarree = true;

  const valeur = document.getElementById("selectTemps").value;

  if (valeur !== "-1") {
    tempsRestant = parseInt(valeur) * 60;
    timerInterval = setInterval(() => {
      tempsRestant--;
      const min = String(Math.floor(tempsRestant / 60)).padStart(2, "0");
      const sec = String(tempsRestant % 60).padStart(2, "0");
      document.getElementById("timer").textContent = `‚è±Ô∏è ${min}:${sec}`;

      if (tempsRestant <= 0) {
        clearInterval(timerInterval);
        alert("‚è∞ Temps √©coul√© ‚Äì derni√®re cl√¥ture !");
      }
    }, 1000);
  } else {
    document.getElementById("timer").textContent = "‚è±Ô∏è ‚àû";
  }
}

/* ===============================
   CL√îTURE DE MARCH√â
================================ */

function clotureMarche() {
  if (!partieDemarree) return;

  // √Ä chaque cl√¥ture, le mode passer repart √† false
  modePasser = false;

  // Le bouton "Passer" appara√Æt uniquement pendant la cl√¥ture
  afficherBoutonPasser();

  numeroCloture++;

  const th = document.createElement("th");
  th.textContent = "Cl√¥ture " + numeroCloture;
  table.rows[0].appendChild(th);

  const actions = Object.keys(prixActions);
  let index = 0;

  function prochaineAction() {
    if (index >= actions.length) {
      document.getElementById("zoneDes").innerHTML = "<p>‚úÖ Cl√¥ture termin√©e</p>";
      cacherBoutonPasser();       // dispara√Æt apr√®s la fin de cl√¥ture
      modePasser = false;
      animationActive = false;
      animationResolve = null;
      return;
    }

    const action = actions[index];
    lancerDes(action, () => {
      const row = table.rows[index + 1];
      const td = document.createElement("td");
      td.textContent = prixActions[action] + " ‚Ç¨";
      row.appendChild(td);
      index++;
      prochaineAction();
    });
  }

  prochaineAction();
}

/* ===============================
   BOUTON PASSER
================================ */

function passerCinematique() {
  // Active le mode "prix directs" pour le reste de la cl√¥ture en cours
  modePasser = true;

  // Si une animation est en cours, on la termine instantan√©ment
  if (animationActive && typeof animationResolve === "function") {
    animationResolve();
  }
}

/* ===============================
   D√âS ANIM√âS (4s)
================================ */

function lancerDes(action, callback) {
  const zone = document.getElementById("zoneDes");

  // Si le modePasser est d√©j√† activ√©, on calcule directement sans cin√©matique
  if (modePasser) {
    const vert = Math.floor(Math.random() * 6) + 1;
    const rouge = Math.floor(Math.random() * 6) + 1;
    appliquerVariationEtAfficher(action, vert, rouge);
    callback();
    return;
  }

  animationActive = true;

  zone.innerHTML = `
    <h2>${action}</h2>
    <div>
      <span class="dice">üé≤</span>
      <span class="dice">üé≤</span>
    </div>
    <p>Lancement des d√©s‚Ä¶</p>
  `;

  let resolu = false;
  let t1 = null;
  let t2 = null;

  // Fonction qui termine l'action courante instantan√©ment (appel√©e par "Passer")
  animationResolve = () => {
    if (resolu) return;
    resolu = true;
    animationActive = false;

    if (t1) clearTimeout(t1);
    if (t2) clearTimeout(t2);

    const vert = Math.floor(Math.random() * 6) + 1;
    const rouge = Math.floor(Math.random() * 6) + 1;
    appliquerVariationEtAfficher(action, vert, rouge);

    // On encha√Æne imm√©diatement
    callback();
  };

  // R√©v√©lation normale √† 2s
  t1 = setTimeout(() => {
    if (resolu) return;
    const vert = Math.floor(Math.random() * 6) + 1;
    const rouge = Math.floor(Math.random() * 6) + 1;
    appliquerVariationEtAfficher(action, vert, rouge);
  }, 2000);

  // Fin normale √† 4s
  t2 = setTimeout(() => {
    if (resolu) return;
    resolu = true;
    animationActive = false;
    animationResolve = null;
    callback();
  }, 4000);
}

function appliquerVariationEtAfficher(action, vert, rouge) {
  const zone = document.getElementById("zoneDes");

  const delta = vert - rouge;
  const variation = delta * 0.1;

  prixActions[action] = Math.max(
    1,
    Math.round(prixActions[action] * (1 + variation))
  );

  zone.innerHTML = `
    <h2>${action}</h2>
    <div style="font-size:50px">
      üü¢ ${vert} &nbsp; üî¥ ${rouge}
    </div>
    <p>Variation : ${delta >= 0 ? "+" : ""}${delta * 10}%</p>
    <p><strong>Nouveau prix :</strong> ${prixActions[action]} ‚Ç¨</p>
  `;
}
</script>

</body>
</html>

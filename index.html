<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STOCKS ‚Äì March√©</title>

  <style>
    :root{
      --bg:#111;
      --panel:#1b1b1b;
      --text:#fff;
      --muted:#9aa0a6;
      --accent:#00ffcc;
      --border:#444;
      --table:#222;
      --tableHead:#333;
    }

    body{
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      text-align: center;
      margin: 0;
      padding: 20px;
    }

    h1{ margin: 20px 0 10px; }

    button, select{
      padding: 10px 15px;
      font-size: 16px;
      margin: 10px;
    }

    #timer{
      font-size: 28px;
      margin: 20px;
      color: var(--accent);
    }

    #marketBox{
      margin: 20px auto;
      padding: 20px;
      border: 2px solid var(--border);
      width: 420px;
      min-height: 180px;
      background: rgba(255,255,255,0.02);
    }

    .dice{
      font-size: 60px;
      display: inline-block;
      margin: 0 20px;
      animation: shake 0.4s infinite;
    }

    @keyframes shake{
      0%{ transform: rotate(0deg); }
      25%{ transform: rotate(10deg); }
      50%{ transform: rotate(-10deg); }
      75%{ transform: rotate(10deg); }
      100%{ transform: rotate(0deg); }
    }

    table{
      margin: 30px auto;
      border-collapse: collapse;
      background: var(--table);
    }

    th, td{
      border: 1px solid #555;
      padding: 8px 12px;
    }

    th{ background: var(--tableHead); }

    #skipBtn{ display:none; }
    .hint{ color: var(--muted); font-size: 13px; margin-top: 4px; }
  </style>
</head>

<body>
  <h1>STOCKS ‚Äì Le Jeu de la Bourse</h1>

  <div>
    ‚è±Ô∏è Dur√©e de la partie :
    <select id="durationSelect">
      <option value="20">20 minutes (mode stress)</option>
      <option value="30" selected>30 minutes (recommand√©)</option>
      <option value="40">40 minutes (mode strat√©gie)</option>
      <option value="-1">Illimit√© (personnalis√©)</option>
    </select>
    <div class="hint">Le chrono d√©marre quand tu cliques sur ‚ÄúCommencer la partie‚Äù.</div>
  </div>

  <div id="timer">‚è±Ô∏è --:--</div>

  <button id="startBtn">‚ñ∂Ô∏è Commencer la partie</button>
  <button id="closeBtn">üìâ Cl√¥ture du march√©</button>
  <button id="skipBtn">‚è≠Ô∏è Passer</button>

  <div id="marketBox">
    <p class="hint">En attente de la cl√¥ture‚Ä¶</p>
  </div>

  <table id="priceTable">
    <thead>
      <tr>
        <th>Action</th>
        <th>Prix initial (‚Ç¨)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
(() => {
  /* ==========================
     Donn√©es
  ========================== */
  const PRICES = {
    "POMME": 80,
    "BOREAL": 72,
    "LOUIS TUIVON": 60,
    "D.E.F.": 55,
    "FT1": 48,
    "SUNGMAS": 40,
    "LLATENU": 35,
    "CARI NOPER": 28,
    "TALTO": 20,
    "SOTA": 15
  };

  /* ==========================
     DOM
  ========================== */
  const els = {
    duration: document.getElementById("durationSelect"),
    timer: document.getElementById("timer"),
    start: document.getElementById("startBtn"),
    close: document.getElementById("closeBtn"),
    skip: document.getElementById("skipBtn"),
    box: document.getElementById("marketBox"),
    table: document.getElementById("priceTable"),
    tbody: document.querySelector("#priceTable tbody"),
    theadRow: document.querySelector("#priceTable thead tr"),
  };

  /* ==========================
     √âtat
  ========================== */
  let gameStarted = false;
  let timeLeftSec = null;
  let clockId = null;

  let closeIndex = 0;
  let closeNumber = 0;

  // gestion "Passer"
  let skipMode = false;              // si activ√©, on calcule sans cin√©matique
  let animRunning = false;           // animation en cours
  let forceResolve = null;           // fonction pour terminer l'action courante

  const ACTIONS = Object.keys(PRICES);

  /* ==========================
     UI helpers
  ========================== */
  function showSkip(show){
    els.skip.style.display = show ? "inline-block" : "none";
  }

  function renderBox(html){
    els.box.innerHTML = html;
  }

  function formatMMSS(total){
    const m = String(Math.floor(total / 60)).padStart(2, "0");
    const s = String(total % 60).padStart(2, "0");
    return `${m}:${s}`;
  }

  function rollDie(){
    return Math.floor(Math.random() * 6) + 1;
  }

  /* ==========================
     Table
  ========================== */
  function initTable(){
    els.tbody.innerHTML = "";
    ACTIONS.forEach(name => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${name}</td><td>${PRICES[name]} ‚Ç¨</td>`;
      els.tbody.appendChild(tr);
    });
  }

  function addCloseColumn(){
    closeNumber += 1;
    const th = document.createElement("th");
    th.textContent = `Cl√¥ture ${closeNumber}`;
    els.theadRow.appendChild(th);
  }

  function appendPriceToRow(rowIndex, value){
    const tr = els.tbody.rows[rowIndex];
    const td = document.createElement("td");
    td.textContent = `${value} ‚Ç¨`;
    tr.appendChild(td);
  }

  /* ==========================
     Chrono
  ========================== */
  function startGame(){
    if (gameStarted) return;
    gameStarted = true;

    const minutes = parseInt(els.duration.value, 10);

    if (minutes === -1){
      els.timer.textContent = "‚è±Ô∏è ‚àû";
      return;
    }

    timeLeftSec = minutes * 60;
    els.timer.textContent = `‚è±Ô∏è ${formatMMSS(timeLeftSec)}`;

    clockId = setInterval(() => {
      timeLeftSec -= 1;
      if (timeLeftSec <= 0){
        clearInterval(clockId);
        clockId = null;
        timeLeftSec = 0;
        els.timer.textContent = "‚è±Ô∏è 00:00";
        alert("‚è∞ Temps √©coul√© ‚Äì derni√®re cl√¥ture !");
        return;
      }
      els.timer.textContent = `‚è±Ô∏è ${formatMMSS(timeLeftSec)}`;
    }, 1000);
  }

  /* ==========================
     Cl√¥ture
  ========================== */
  function startClose(){
    if (!gameStarted) return;

    skipMode = false;
    closeIndex = 0;
    showSkip(true);
    addCloseColumn();

    nextAction();
  }

  function nextAction(){
    if (closeIndex >= ACTIONS.length){
      renderBox("<p>‚úÖ Cl√¥ture termin√©e</p>");
      showSkip(false);
      animRunning = false;
      forceResolve = null;
      return;
    }

    const actionName = ACTIONS[closeIndex];
    handleActionClose(actionName, () => {
      appendPriceToRow(closeIndex, PRICES[actionName]);
      closeIndex += 1;
      nextAction();
    });
  }

  function handleActionClose(actionName, done){
    if (skipMode){
      const g = rollDie();
      const r = rollDie();
      applyAndDisplay(actionName, g, r);
      done();
      return;
    }

    animRunning = true;
    renderBox(`
      <h2>${actionName}</h2>
      <div>
        <span class="dice">üé≤</span>
        <span class="dice">üé≤</span>
      </div>
      <p>Lancement des d√©s‚Ä¶</p>
    `);

    let resolved = false;
    let tReveal = null;
    let tFinish = null;

    forceResolve = () => {
      if (resolved) return;
      resolved = true;
      animRunning = false;

      if (tReveal) clearTimeout(tReveal);
      if (tFinish) clearTimeout(tFinish);

      const g = rollDie();
      const r = rollDie();
      applyAndDisplay(actionName, g, r);
      forceResolve = null;
      done();
    };

    tReveal = setTimeout(() => {
      if (resolved) return;
      const g = rollDie();
      const r = rollDie();
      applyAndDisplay(actionName, g, r);
    }, 2000);

    tFinish = setTimeout(() => {
      if (resolved) return;
      resolved = true;
      animRunning = false;
      forceResolve = null;
      done();
    }, 4000);
  }

  function applyAndDisplay(actionName, green, red){
    const delta = green - red;
    const variation = delta * 0.1;

    PRICES[actionName] = Math.max(1, Math.round(PRICES[actionName] * (1 + variation)));

    renderBox(`
      <h2>${actionName}</h2>
      <div style="font-size:50px">üü¢ ${green} &nbsp; üî¥ ${red}</div>
      <p>Variation : ${delta >= 0 ? "+" : ""}${delta * 10}%</p>
      <p><strong>Nouveau prix :</strong> ${PRICES[actionName]} ‚Ç¨</p>
    `);
  }

  function skipCinematic(){
    skipMode = true;
    if (animRunning && typeof forceResolve === "function"){
      forceResolve();
    }
  }

  /* ==========================
     Events
  ========================== */
  els.start.addEventListener("click", startGame);
  els.close.addEventListener("click", startClose);
  els.skip.addEventListener("click", skipCinematic);

  /* init */
  initTable();
})();
</script>

</body>
</html>
